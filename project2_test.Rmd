---
title: "project2_test"
author: "Group_01"
date: "2021/7/7"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA)
```

```{r libraries}
library(tidyverse)
library(moderndive)
library(skimr)
library(kableExtra)
library(gridExtra)
library(broom)
library(plotly)
library(GGally)
library(sjPlot)
library(janitor)
library(leaps)
```

```{r data, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
data <- read.csv("dataset1.csv")
data<-data[,-2] #remove region colummn as all entries the same
```


```{r data.score}
data.score <- data %>%
  dplyr::select(Total.Number.of.Family.members,Total.Household.Income,
                Total.Food.Expenditure, Household.Head.Age, House.Floor.Area, House.Age,
                Number.of.bedrooms, Electricity)
```

```{r distribution of response variable, eval = TRUE, fig.align='center', out.width='80%', fig.pos = "H"}
barplot1<- ggplot(data, aes(x=Total.Number.of.Family.members))+ 
  geom_bar(color = "white") +
  theme(legend.position="none", plot.title=element_text(hjust=0.5))+
      labs(x ="Number of Members in a Household");barplot1
```

```{r summary of levels of response variables}
table_members<-data%>% 
  tabyl(Total.Number.of.Family.members) %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(); table_members
```

```{r correlation}
data.score %>%
  cor()
```

```{r pairs}
ggpairs(data.score, aes(colour = as.factor(data$Household.Head.Sex), alpha = 0.4))
```

```{r numerical summaries}
my_skim <- skim_with(numeric = sfl(hist = NULL))
my_skim(data.score)  %>%
  dplyr::select(-skim_type) %>%
  as_tibble() %>%
  kable(col.names = c("Variable", "Missing", "Complete", "Mean", "SD", "Min.", "1st Q.",
                      "Median", "3rd Q.", "Max."),
        caption = "Summary statistics of numerical variables",
        booktabs = TRUE,  digits = 2) %>%
  kable_styling(font_size = 10, latex_options = "hold_position") #create a summarized statistics table for the three variables
```

```{r categorical summaries}
data.cat<-as.data.frame(cbind(data$Household.Head.Sex, data$Type.of.Household))
colnames(data.cat)<-c("Household.Head.Sex", "Type.of.Household")

table_household<- data.cat %>% 
  tabyl(Type.of.Household) %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(); table_household

table_sex<-data.cat %>% 
  tabyl(Household.Head.Sex) %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(); table_sex

```

## Gender & Age
```{r gender data}
data.gender <- data %>%
  select(Household.Head.Sex, Household.Head.Age)
```

```{r boxplot of age by gender}
ggplot(data = data.gender, aes(x = Household.Head.Sex, y = Household.Head.Age, fill = Household.Head.Sex)) +
  geom_boxplot() +
  labs(x = "Gender", y = "Age")+ 
  theme(legend.position = "none")
```

## Household Income Balance

```{r balance}
data.balance <- data %>%
  select(Total.Household.Income, Total.Food.Expenditure)
```

```{r balance boxplot}
ggplot(data.balance, aes(y=Total.Household.Income)) +
  geom_boxplot(color="black") +
  labs(x="",y="Total Household Income", title="Total Household Income") +
  theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels=NULL)
```

```{r balance boxplot}
ggplot(data.balance, aes(y=log(Total.Household.Income))) +
  geom_boxplot(color="black") +
  labs(x="",y="Log Total Household Income", title="Log Total Household Income") +
  theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels=NULL)
```

```{r balance_plot}
ggplot(data = data.balance, aes(x = Total.Household.Income, y = Total.Food.Expenditure)) +
  geom_point(color="black", position="jitter", alpha=0.5) +
  labs(x = "Income", y = "Expenditure") +
  geom_smooth(method = glm, se = FALSE, color="red") +
  theme(legend.position = "none")
```

The above plot highlights a possible outlier in terms of income, this could be a data entry error or just an outlier. Removing this observation from the data set and plotting provides the following scatter diagram.

```{r balance without outlier}
index<-which.max(data.balance$Total.Household.Income)
balance_without_outlier<- data.balance[-index,]
ggplot(data = balance_without_outlier, aes(x = Total.Household.Income, y = Total.Food.Expenditure)) +
  geom_point(color="black", position="jitter", alpha=0.5) +
  labs(x = "Income", y = "Expenditure") +
  geom_smooth(method = glm, se = FALSE, color="red") +
  theme(legend.position = "none")
```

## Model

```{r}
models <- regsubsets(Total.Number.of.Family.members~., data = data, nvmax = 10)
summary(models)
res.sum <- summary(models)
selection.criteria<- c(Adj.R2 = which.max(res.sum$adjr2), CP = which.min(res.sum$cp),
  BIC = which.min(res.sum$bic)); selection.criteria
```

```{r full numerical model}
model_full <- glm(Total.Number.of.Family.members ~ Total.Household.Income +
                Total.Food.Expenditure + Household.Head.Age + House.Floor.Area + House.Age +
                Number.of.bedrooms + Electricity, data = data)
```

```{r full numerical model summary}
model_full %>%
  summary()
```

```{r significant factors model}
model_significant <- glm(Total.Number.of.Family.members ~ Total.Household.Income +
                Total.Food.Expenditure + House.Age +
                Number.of.bedrooms, data = data)
```

```{r summary of significant factors model}
model_significant %>%
  summary()
```

```{r model comparison}
Models <- c('Full Model','Significant Factors Model')
bind_rows(glance(model_full), glance(model_significant),.id="Model") %>%
  select(Model,AIC,BIC) %>%
  mutate(Model=Models) %>%  
  kable(booktabs = TRUE,digits = 2) %>% 
  kable_styling(latex_options = 'HOLD_position', ) # to get a table of AIC & BIC
```


## Family Members & Gender
```{r}
data.sex_number <- data %>%
  select(Household.Head.Sex, Total.Number.of.Family.members)
```

```{r}
ggplot(data = data.sex_number, aes(x = Household.Head.Sex, y = Total.Number.of.Family.members, fill = Household.Head.Sex)) +
  geom_boxplot() +
  labs(x = "Gender", y = "Number of Family member")+ 
  theme(legend.position = "none")
```

## Log-odds
```{r}
data.sex_number$Household.Head.Sex <- as.factor(data.sex_number$Household.Head.Sex)
```

```{r}
model_sex_number <- glm(Household.Head.Sex ~ Total.Number.of.Family.members, data = data.sex_number,
                        family = binomial(link = "logit"))
```

```{r}
model_sex_number %>%
  summary()
```

```{r}
levels(data.sex_number$Household.Head.Sex)
```

```{r}
modelcoefs <- round(coef(model_sex_number),2)
```



\begin{align} \ln\left(\frac{p}{1-p}\right) &= \alpha + \beta \cdot \textrm{number of family members} = `r modelcoefs[1]` + `r modelcoefs[2]` \cdot 
\textrm{number of family members}, \nonumber \end{align}

Where $p = Prob(Male)$ and $1-p = Prob(Female)$.
Hence, the log-odds of the household being male increase by 0.18 for every one unit increase in number of family members. This provides us with a point estimate of how the log-odds changes with age. 

However, we are also interested in producing a 95% confidence interval for these log-odds.

```{r}
confint(model_sex_number) %>%
  kable()
```

```{r}
plot_model(model_sex_number, show.values = TRUE, transform = NULL,
           title = "Log-Odds (Male household)", show.p = FALSE)
```

Now, let's add the estimates of the log-odds to our data set:

```{r}
data.sex_number <- data.sex_number %>%
  mutate(logodds.male = predict(model_sex_number))
```

## Odds

```{r}
plot_model(model_sex_number, show.values = TRUE, axis.lim = c(1,1.5),
           title = "Odds (Male household)", show.p = FALSE)
```


Now, let's add the estimates of the odds to our data set:

```{r}
data.sex_number <- data.sex_number %>%
  mutate(odds.male = exp(logodds.male))
```


## Probabilities

```{r}
data.sex_number <- data.sex_number %>%
  mutate(probs.male = fitted(model_sex_number))
```


## Plot the probability of being male

```{r}
ggplot(data = data.sex_number, aes(x = Total.Number.of.Family.members, y = probs.male)) +
  geom_smooth(method="glm", 
              method.args = list(family="binomial"), 
              se = FALSE) +
  labs(x = "number of family members", y = "Probability of household being male")
```

```{r}
plot_model(model_sex_number, type = "pred", title = "",
            axis.title = c("number of family members", "Prob. of household being male"))
```

## GLM

```{r factors}
data$Total.Number.of.Family.members<-as.factor(data$Total.Number.of.Family.members)
data$Household.Head.Sex<- as.factor(data$Household.Head.Sex)
data$Type.of.Household<-as.factor(data$Type.of.Household)
```

```{r glm test model}
test.model<- glm(Total.Number.of.Family.members~ Total.Household.Income +
                Total.Food.Expenditure + Household.Head.Sex + Household.Head.Age + Type.of.Household + House.Floor.Area + House.Age + Number.of.bedrooms + Electricity, data=data, family = binomial(link = "logit"))

test.model%>% summary()
```


```{r glm sex interactions test model}
int.test.model<- glm(Total.Number.of.Family.members~ (Total.Household.Income +
                Total.Food.Expenditure + Household.Head.Age + Type.of.Household + House.Floor.Area + House.Age + Number.of.bedrooms + Electricity)* Household.Head.Sex, data=data, family = binomial(link = "logit"))

int.test.model%>% summary()
```

```{r model comparison 2}
Models <- c('No Interactions','Interactions with Head of Household Sex')
bind_rows(glance(test.model), glance(int.test.model),.id="Model") %>%
  select(Model,AIC,BIC) %>%
  mutate(Model=Models) %>%  
  kable(booktabs = TRUE,digits = 2) %>% 
  kable_styling(latex_options = 'HOLD_position', )
```


